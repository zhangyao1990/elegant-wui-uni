var e=Object.defineProperty,a=Object.defineProperties,l=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(a,l,t)=>l in a?e(a,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[l]=t,i=(e,a)=>{for(var l in a||(a={}))u.call(a,l)&&s(e,l,a[l]);if(t)for(var l of t(a))o.call(a,l)&&s(e,l,a[l]);return e},c=(e,t)=>a(e,l(t));import{d as n,r,L as v,H as m,z as p,c as d,a as h,x as f,g,w,h as y,i as x,B as _,s as b,j as k,ao as S,k as T,t as C,u as M,aq as P,aj as $,ap as V,e as j,f as I,n as N,F,p as O,ak as H}from"./index-CnRAlpd-.js";import{c as z,l as q,m as R,t as U,k as W,E as A,o as X,e as Y,b as B,a as E,f as D,_ as L}from"./page-wraper.DMME2CXH.js";import{_ as G}from"./wui-button.Bcr_H9ae.js";import{u as J}from"./useTranslate.DCsJG8gA.js";import{_ as K}from"./wui-img.bauLhy_f.js";import{_ as Q}from"./demo-block.BWMqEgaZ.js";import{a as Z}from"./types.S9j9C-lg.js";const ee=c(i({},z),{modelValue:W(!1),cancelButtonText:String,confirmButtonText:String,disabledRotate:W(!1),fileType:q("png"),quality:R(1),exportScale:R(2),imgSrc:q(""),imgWidth:U(""),imgHeight:U(""),maxScale:R(3),aspectRatio:q("1:1")}),ae=n(c(i({},{name:"wui-img-cropper",options:{virtualHost:!0,addGlobalClass:!0,styleIsolation:"shared"}}),{props:ee,emits:["imgloaded","imgloaderror","cancel","confirm","update:modelValue"],setup(e,{expose:a,emit:l}){const t=r(`cropper${A()}`);let u=null,o=null,s=!0,i=null,c=null;const n=.85,j=e,I=l,{translate:N}=J("img-cropper"),F=r(0),O=r(!1),H=r(0),z=r(0),q=r(0),R=r(0),U=r(20),W=r(0),E=r(0),D=r(""),L=r(""),K=r(2),Q=r(1),Z=r(v().windowWidth/2),ee=r(v().windowHeight/2*n),ae=r(null),le=r(v()),te=r(!0),ue=r([{x:"",y:""},{x:"",y:""}]),oe=r(""),se=r(null),{proxy:ie}=m();p((()=>j.modelValue),(e=>{if(e){i=j.imgWidth,c=j.imgHeight,le.value=v();const[e,a]=j.aspectRatio.split(":").map(Number),l=le.value.windowWidth-2*U.value,u=l*a/e;q.value=l,R.value=u,E.value=(le.value.windowHeight*n-u)/2,W.value=U.value,K.value=j.exportScale,L.value=u,D.value=l,function(){if(i&&"string"==typeof i&&-1!==i.indexOf("%")){const e=i.replace("%","");i=le.value.windowWidth/100*Number(e),H.value=i}else i&&"number"==typeof i&&(H.value=i);if(c&&"string"==typeof c&&-1!==c.indexOf("%")){const e=j.imgHeight.replace("%","");c=le.value.windowHeight/100*Number(e),H.value=c}else c&&"number"==typeof c&&(H.value=Number(i))}(),se.value||(se.value=V(t.value,ie)),j.imgSrc&&pe()}else me()}),{deep:!0,immediate:!0}),p((()=>j.imgSrc),(e=>{e&&pe()}),{deep:!0,immediate:!0}),p((()=>F.value),(e=>{e%90&&(F.value=90*Math.round(e/90))}),{deep:!0,immediate:!0}),p((()=>O.value),(e=>{u&&clearTimeout(u),e&&(u=setTimeout((()=>{re(!1),clearTimeout(u)}),300))}),{deep:!0,immediate:!0});const ce=d((()=>X({position:"absolute",right:0,width:"56px","border-radius":"16px","font-size":"16px"}))),ne=d((()=>{const e={width:H.value?Y(H.value):"auto",height:z.value?Y(z.value):"auto",transform:`translate(${Y(Z.value-H.value/2)}, ${Y(ee.value-z.value/2)}) scale(${Q.value}) rotate(${F.value}deg)`,"transition-duration":(O.value?.4:0)+"s"};return X(e)}));function re(e){O.value=e}function ve(e){if(!e||j.disabledRotate)return;re(!0),F.value=e;let a=H.value,l=z.value;e/90%2&&(a=z.value,l=H.value);const t=q.value/a,u=R.value/l;Q.value=Math.max(t,u),de()}function me(){const{windowHeight:e,windowWidth:a}=v();Q.value=1,F.value=0,Z.value=a/2,ee.value=e/2*n}function pe(){j.imgSrc&&$({src:j.imgSrc,success:e=>{ae.value=e,function(){let e=H.value,a=z.value;if(c||i)c&&!i?(a=Number(c),e=ae.value.width/ae.value.height*a):(!c&&i||c&&i)&&(e=Number(i),a=ae.value.height/ae.value.width*e);else{const l=ae.value.width/ae.value.height;l>q.value/R.value?(a=R.value,e=a*l):(e=q.value,a=e/l)}const l=q.value/e,t=R.value/a,u=Math.max(l,t);H.value=e,z.value=a,Q.value=u}(),me()},fail:()=>{}})}function de(e){const a=e||Q.value;let l=Z.value,t=ee.value,u=H.value,o=z.value;F.value/90%2&&(u=z.value,o=H.value),l=u*a/2+W.value>=l?l:u*Q.value/2+W.value,l=W.value+q.value-u*a/2<=l?l:W.value+q.value-u*a/2,t=o*a/2+E.value>=t?t:o*a/2+E.value,t=E.value+R.value-o*a/2<=t?t:E.value+R.value-o*a/2,Q.value=a,ee.value=t,Z.value=l}function he(e){if(te.value=!1,1===e.touches.length)ue.value[0]={x:e.touches[0].clientX-Z.value,y:e.touches[0].clientY-ee.value};else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY);oe.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function fe(e){if(!te.value&&s)if("android"===le.value.platform?(o&&clearTimeout(o),o=setTimeout((()=>{s=!0}),25)):!s&&(s=!0),1===e.touches.length){const{x:a,y:l}=ue.value[0],t=e.touches[0].clientX-Number(a),u=e.touches[0].clientY-Number(l);Z.value=t,ee.value=u,de()}else{const a=Math.abs(e.touches[1].clientX-e.touches[0].clientX),l=Math.abs(e.touches[1].clientY-e.touches[0].clientY),t=Math.sqrt(Math.pow(a,2)+Math.pow(l,2)),u=Q.value*(t/Number(oe.value));Q.value=Math.min(u,j.maxScale),function(){let e=H.value,a=z.value,l=Q.value;F.value/90%2&&(e=z.value,a=H.value),e*l<q.value&&(l=q.value/e),a*l<R.value&&(l=R.value/a),de(l)}(),oe.value=Math.sqrt(Math.pow(a,2)+Math.pow(l,2))}}function ge(){te.value=!0}function we(e){I("imgloaded",e)}function ye(e){I("imgloaderror",e)}function xe(){ve(F.value-90)}function _e(){I("cancel"),I("update:modelValue",!1)}function be(){!function(){if(!j.imgSrc)return;const e=()=>{const e=H.value*Q.value*j.exportScale,a=z.value*Q.value*j.exportScale,l=Z.value-W.value,u=ee.value-E.value;se.value.translate(l*j.exportScale,u*j.exportScale),j.disabledRotate||se.value.rotate(F.value*Math.PI/180),se.value.drawImage(j.imgSrc,-e/2,-a/2,e,a),se.value.restore(),se.value.draw(!1,(()=>{!function(){const{fileType:e,quality:a,exportScale:l}=j;P({width:q.value*l,height:Math.round(R.value*l),destWidth:q.value*l,destHeight:Math.round(R.value*l),fileType:e,quality:a,canvasId:t.value,success:e=>{const a={tempFilePath:e.tempFilePath,width:q.value*l,height:R.value*l};I("confirm",a)},complete:()=>{I("update:modelValue",!1)}},ie)}()}))};L.value=R.value,D.value=q.value,e()}()}function ke(){}return a({revertIsAnimation:re,setRoate:ve,resetImg:me}),(e,a)=>{const l=x,u=k,o=S;return e.modelValue?(g(),h(l,{key:0,class:b(`wui-img-cropper ${e.customClass}`),style:_(e.customStyle),onTouchmove:ke},{default:w((()=>[y(l,{class:"wui-img-cropper__wrapper"},{default:w((()=>[y(l,{class:"wui-img-cropper__cut"},{default:w((()=>[y(l,{class:b("wui-img-cropper__cut--top "+(te.value?"":"is-hightlight")),style:_(`height: ${E.value}px;`)},null,8,["class","style"]),y(l,{class:"wui-img-cropper__cut--middle",style:_(`height: ${R.value}px;`)},{default:w((()=>[y(l,{class:b("wui-img-cropper__cut--left "+(te.value?"":"is-hightlight")),style:_(`width: ${W.value}px; height: ${R.value}px;`)},null,8,["class","style"]),y(l,{class:"wui-img-cropper__cut--body",style:_(`width: ${q.value}px; height: ${R.value}px;`)},{default:w((()=>[y(l,{class:"is-gridlines-x"}),y(l,{class:"is-gridlines-y"}),y(l,{class:"is-left-top"}),y(l,{class:"is-left-bottom"}),y(l,{class:"is-right-top"}),y(l,{class:"is-right-bottom"})])),_:1},8,["style"]),y(l,{class:b("wui-img-cropper__cut--right "+(te.value?"":"is-hightlight"))},null,8,["class"])])),_:1},8,["style"]),y(l,{class:b("wui-img-cropper__cut--bottom "+(te.value?"":"is-hightlight"))},null,8,["class"])])),_:1}),y(u,{prop:O.value,"change:prop":e.animation?e.animation.setAnimation:"",class:"wui-img-cropper__img",src:e.imgSrc,style:_(ne.value),"lazy-load":!1,onTouchstart:he,onTouchmove:fe,onTouchend:ge,onError:ye,onLoad:we},null,8,["prop","change:prop","src","style"])])),_:1}),y(o,{"canvas-id":t.value,id:t.value,class:"wui-img-cropper__canvas","disable-scroll":!0,style:_(`width: ${Number(D.value)*K.value}px; height: ${Number(L.value)*K.value}px;`)},null,8,["canvas-id","id","style"]),y(l,{class:"wui-img-cropper__footer"},{default:w((()=>[e.disabledRotate?f("",!0):(g(),h(B,{key:0,"custom-class":"wui-img-cropper__rotate",name:"rotate",onClick:xe})),y(l,{class:"wui-img-cropper__footer--button"},{default:w((()=>[y(l,{class:"is-cancel",onClick:_e},{default:w((()=>[T(C(e.cancelButtonText||M(N)("cancel")),1)])),_:1}),y(G,{size:"small","custom-style":ce.value,onClick:be},{default:w((()=>[T(C(e.confirmButtonText||M(N)("confirm")),1)])),_:1},8,["custom-style"])])),_:1})])),_:1})])),_:1},8,["class","style"])):f("",!0)}}}));const le={setAnimation:function(e,a,l){if(e)var t=l.setTimeout((function(){l.callMethod("revertIsAnimation",!1),l.clearTimeout(t)}),300)}},te=e=>{e.$wxs||(e.$wxs=[]),e.$wxs.push("animation"),e.mixins||(e.mixins=[]),e.mixins.push({beforeCreate(){this.animation=le}})};te(ae);const ue=E(ae,[["__scopeId","data-v-bf517539"]]),oe=E(n({__name:"Index",setup(e){const{startUpload:a,UPLOAD_STATUS:l}=Z(),{show:t}=D(),u=r(""),o=r(""),s=r(!1),i=r([!1,!1,!1]),c=r(["","",""]),n=r(["","",""]),v=r(!1),m=r(""),p=r("");function d(){H({count:1,success:e=>{const a=e.tempFilePaths[0];u.value=a,s.value=!0}})}function _(e){H({count:1,success:a=>{const l=a.tempFilePaths[0];c.value[e]=l,i.value[e]=!0}})}function b(){H({count:1,success:e=>{m.value=e.tempFilePaths[0],v.value=!0}})}function k(e){const{tempFilePath:a}=e;o.value=a}function S(e){return u=this,o=null,s=function*(){const{tempFilePath:u}=e,o={url:u,status:l.PENDING,percent:0,uid:(new Date).getTime()};try{yield a(o,{action:"https://mockapi.eolink.com/zhTuw2P8c29bc981a741931bdd86eb04dc1e8fd64865cb5/upload",onSuccess(){p.value=u,t({msg:"上传成功"})},onError(){t({msg:"上传失败"})},onProgress(e){console.log("上传进度:",e.progress)}})}catch(s){console.error("上传失败:",s)}},new Promise(((e,a)=>{var l=e=>{try{i(s.next(e))}catch(l){a(l)}},t=e=>{try{i(s.throw(e))}catch(l){a(l)}},i=a=>a.done?e(a.value):Promise.resolve(a.value).then(l,t);i((s=s.apply(u,o)).next())}));var u,o,s}function M(e){console.log("加载失败",e)}function P(e){console.log("加载成功",e)}function $(e){console.log("取消",e)}function V(e){console.log("取消",e)}function z(e){const[a,l]=e.split(":").map(Number);return"1:1"===e?"200px":300*l/a+"px"}return(e,a)=>{const l=j(I("wui-img-cropper"),ue),t=j(I("wui-icon"),B),r=x,H=j(I("wui-img"),K),q=j(I("demo-block"),Q),R=j(I("page-wraper"),L);return g(),h(R,null,{default:w((()=>[y(q,{title:"基本用法",style:{"text-align":"center"}},{default:w((()=>[y(l,{modelValue:s.value,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value=e),"img-src":u.value,onConfirm:k,onCancel:$,onImgloaderror:M,onImgloaded:P},null,8,["modelValue","img-src"]),y(r,{class:"profile"},{default:w((()=>[o.value?f("",!0):(g(),h(r,{key:0,class:"img",onClick:d},{default:w((()=>[y(t,{name:"fill-camera","custom-class":"img-icon"})])),_:1})),o.value?(g(),h(H,{key:1,round:"",width:"200px",height:"200px",src:o.value,mode:"aspectFit","custom-class":"profile-img",onClick:d},null,8,["src"])):f("",!0),y(r,{style:{"font-size":"14px"}},{default:w((()=>[T("点击上传头像")])),_:1})])),_:1})])),_:1}),y(q,{title:"自定义裁剪比例",style:{"text-align":"center"}},{default:w((()=>[y(r,{class:"profile-grid"},{default:w((()=>[(g(),N(F,null,O(["3:2","16:9","16:10"],((e,a)=>y(r,{key:a,class:"profile-item"},{default:w((()=>[y(l,{modelValue:i.value[a],"onUpdate:modelValue":e=>i.value[a]=e,"img-src":c.value[a],"aspect-ratio":e,onConfirm:e=>function(e,a){const{tempFilePath:l}=a;n.value[e]=l}(a,e),onCancel:V},null,8,["modelValue","onUpdate:modelValue","img-src","aspect-ratio","onConfirm"]),n.value[a]?f("",!0):(g(),h(r,{key:0,class:"img",onClick:e=>_(a)},{default:w((()=>[y(t,{name:"fill-camera","custom-class":"img-icon"})])),_:2},1032,["onClick"])),n.value[a]?(g(),h(H,{key:1,width:"300px",height:z(e),src:n.value[a],mode:"aspectFit","custom-class":"profile-img",onClick:e=>_(a)},null,8,["height","src","onClick"])):f("",!0),y(r,{style:{"font-size":"14px"}},{default:w((()=>[T(C(e)+" 比例裁剪",1)])),_:2},1024)])),_:2},1024))),64))])),_:1})])),_:1}),y(q,{title:"裁剪后上传",style:{"text-align":"center"}},{default:w((()=>[y(l,{modelValue:v.value,"onUpdate:modelValue":a[1]||(a[1]=e=>v.value=e),"img-src":m.value,onConfirm:S,onCancel:$},null,8,["modelValue","img-src"]),y(r,{class:"profile"},{default:w((()=>[p.value?f("",!0):(g(),h(r,{key:0,class:"img",onClick:b},{default:w((()=>[y(t,{name:"fill-camera","custom-class":"img-icon"})])),_:1})),p.value?(g(),h(H,{key:1,round:"",width:"200px",height:"200px",src:p.value,mode:"aspectFit","custom-class":"profile-img",onClick:b},null,8,["src"])):f("",!0),y(r,{style:{"font-size":"14px"}},{default:w((()=>[T("点击上传裁剪后的头像")])),_:1})])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-6b3b0fab"]]);export{oe as default};
